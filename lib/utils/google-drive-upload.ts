import { google } from "googleapis";
import { refreshAccessToken, isTokenExpired, setOAuth2Credentials } from "./google-oauth-client";
import tokenStorage from "./google-token-storage";
import type { GoogleOAuthToken } from "@/types/index";

/**
 * ì‚¬ìš©ìì˜ í˜„ì¬ í† í° ì¡°íšŒ ë° ê°±ì‹  (í•„ìš”ì‹œ)
 *
 * ğŸ”¥ í•µì‹¬ ë™ì‘:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * 1ï¸âƒ£ ì €ì¥ëœ í† í° í™•ì¸
 * 2ï¸âƒ£ ë§Œë£Œ ì—¬ë¶€ ì²´í¬ (5ë¶„ ë²„í¼ë¡œ ë¯¸ë¦¬ ê°±ì‹ )
 * 3ï¸âƒ£ refresh_tokenìœ¼ë¡œ ìƒˆë¡œìš´ access_token ë°œê¸‰
 * 4ï¸âƒ£ í† í° ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
 * 5ï¸âƒ£ íŒŒì¼ ì—…ë¡œë“œ ê³„ì† ì§„í–‰
 *
 * ğŸ“Œ ì´ ë¡œì§ì´ ìˆì–´ì•¼:
 *   - ë¸”ë¡œê·¸ ìë™ ì—…ë¡œë“œ ê°€ëŠ¥
 *   - ì‚¬ìš©ìê°€ ê³„ì† ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€
 *   - ì™„ì „ ìë™í™” ê°€ëŠ¥ âœ…
 */
async function getValidToken(userEmail: string): Promise<GoogleOAuthToken> {
  console.log(`ğŸ” ì‚¬ìš©ì í† í° ì¡°íšŒ: ${userEmail}`);

  const token = tokenStorage.get(userEmail);

  if (!token) {
    throw new Error(`ì €ì¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤: ${userEmail}`);
  }

  // í† í°ì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸ (5ë¶„ ë²„í¼ í¬í•¨)
  if (isTokenExpired(token.expiry_date)) {
    console.log(`âš ï¸ í† í°ì´ ê³§ ë§Œë£Œë©ë‹ˆë‹¤. Refresh tokenìœ¼ë¡œ ê°±ì‹  ì¤‘...`);
    console.log("ğŸ’¡ ì´ ìë™ ê°±ì‹ ì´ ê°€ëŠ¥í•œ ì´ìœ : access_type=offline + prompt=consent");

    if (!token.refresh_token) {
      throw new Error(
        "âŒ Refresh tokenì´ ì—†ì–´ì„œ í† í°ì„ ê°±ì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n" +
        "ì›ì¸: ì²˜ìŒ ë¡œê·¸ì¸ ì‹œ access_type=offline ë˜ëŠ” prompt=consent ì˜µì…˜ ëˆ„ë½\n" +
        "í•´ê²°: ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš” (Google ë³´ì•ˆì—ì„œ ì•± ì‚­ì œ í›„)"
      );
    }

    // Refresh tokenìœ¼ë¡œ ìƒˆë¡œìš´ access token ë°œê¸‰
    const newTokenData = await refreshAccessToken(token.refresh_token);

    // í† í° ì—…ë°ì´íŠ¸
    tokenStorage.update(userEmail, newTokenData.access_token, newTokenData.expiry_date);

    // ì—…ë°ì´íŠ¸ëœ í† í° ë°˜í™˜
    const updatedToken = tokenStorage.get(userEmail);
    if (!updatedToken) {
      throw new Error("í† í° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
    }

    return updatedToken;
  }

  console.log("âœ… ìœ íš¨í•œ í† í° í™•ì¸ë¨");
  return token;
}

/**
 * Google Driveì— íŒŒì¼ ì—…ë¡œë“œ
 *
 * @param userEmail - ì‚¬ìš©ì ì´ë©”ì¼
 * @param fileName - ì—…ë¡œë“œí•  íŒŒì¼ëª…
 * @param fileContent - íŒŒì¼ ë‚´ìš© (ë¬¸ìì—´ ë˜ëŠ” Buffer)
 * @param mimeType - MIME íƒ€ì… (ê¸°ë³¸ê°’: text/plain)
 * @returns ì—…ë¡œë“œëœ íŒŒì¼ ID
 */
export async function uploadFileToDrive(
  userEmail: string,
  fileName: string,
  fileContent: string | Buffer,
  mimeType: string = "text/plain"
): Promise<string> {
  try {
    console.log(`ğŸ“¤ Google Drive ì—…ë¡œë“œ ì‹œì‘: ${fileName}`);

    // 1ï¸âƒ£ ìœ íš¨í•œ í† í° ê°€ì ¸ì˜¤ê¸° (ìë™ ê°±ì‹  í¬í•¨)
    const token = await getValidToken(userEmail);

    // 2ï¸âƒ£ Google API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const oauth2Client = new google.auth.OAuth2(
      process.env.GOOGLE_CLIENT_ID,
      process.env.GOOGLE_CLIENT_SECRET,
      process.env.GOOGLE_REDIRECT_URI
    );

    setOAuth2Credentials(oauth2Client, token);

    // 3ï¸âƒ£ Google Drive API ì´ˆê¸°í™”
    const drive = google.drive({
      version: "v3",
      auth: oauth2Client,
    });

    // 4ï¸âƒ£ íŒŒì¼ ì—…ë¡œë“œ
    console.log(`ğŸ“ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸: ${fileName}`);

    const response = await drive.files.create({
      requestBody: {
        name: fileName,
        mimeType,
        description: "Auto-generated by Blog AI",
        parents: undefined, // ìµœìƒìœ„ ë””ë ‰í† ë¦¬ì— ì €ì¥
      },
      media: {
        mimeType,
        body: fileContent,
      },
      fields: "id, webViewLink", // ë°˜í™˜ í•„ë“œ
    });

    const fileId = response.data.id;
    const webViewLink = response.data.webViewLink;

    console.log("âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ");
    console.log(`ğŸ“ íŒŒì¼ ID: ${fileId}`);
    console.log(`ğŸ”— ì›¹ ë§í¬: ${webViewLink}`);

    return fileId || "";
  } catch (error) {
    console.error("âŒ Google Drive ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
    throw error;
  }
}

/**
 * Google Driveì—ì„œ íŒŒì¼ ì—…ë°ì´íŠ¸
 *
 * @param userEmail - ì‚¬ìš©ì ì´ë©”ì¼
 * @param fileId - ì—…ë°ì´íŠ¸í•  íŒŒì¼ ID
 * @param fileContent - ìƒˆë¡œìš´ íŒŒì¼ ë‚´ìš©
 * @param mimeType - MIME íƒ€ì…
 */
export async function updateFileInDrive(
  userEmail: string,
  fileId: string,
  fileContent: string | Buffer,
  mimeType: string = "text/plain"
): Promise<void> {
  try {
    console.log(`ğŸ“ Google Drive íŒŒì¼ ì—…ë°ì´íŠ¸: ${fileId}`);

    // ìœ íš¨í•œ í† í° ê°€ì ¸ì˜¤ê¸°
    const token = await getValidToken(userEmail);

    // Google API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const oauth2Client = new google.auth.OAuth2(
      process.env.GOOGLE_CLIENT_ID,
      process.env.GOOGLE_CLIENT_SECRET,
      process.env.GOOGLE_REDIRECT_URI
    );

    setOAuth2Credentials(oauth2Client, token);

    const drive = google.drive({
      version: "v3",
      auth: oauth2Client,
    });

    // íŒŒì¼ ì—…ë°ì´íŠ¸
    await drive.files.update({
      fileId,
      media: {
        mimeType,
        body: fileContent,
      },
    });

    console.log("âœ… íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
  } catch (error) {
    console.error("âŒ Google Drive íŒŒì¼ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
    throw error;
  }
}

/**
 * Google Driveì—ì„œ íŒŒì¼ ì‚­ì œ
 *
 * @param userEmail - ì‚¬ìš©ì ì´ë©”ì¼
 * @param fileId - ì‚­ì œí•  íŒŒì¼ ID
 */
export async function deleteFileFromDrive(
  userEmail: string,
  fileId: string
): Promise<void> {
  try {
    console.log(`ğŸ—‘ï¸ Google Drive íŒŒì¼ ì‚­ì œ: ${fileId}`);

    const token = await getValidToken(userEmail);

    const oauth2Client = new google.auth.OAuth2(
      process.env.GOOGLE_CLIENT_ID,
      process.env.GOOGLE_CLIENT_SECRET,
      process.env.GOOGLE_REDIRECT_URI
    );

    setOAuth2Credentials(oauth2Client, token);

    const drive = google.drive({
      version: "v3",
      auth: oauth2Client,
    });

    await drive.files.delete({
      fileId,
    });

    console.log("âœ… íŒŒì¼ ì‚­ì œ ì™„ë£Œ");
  } catch (error) {
    console.error("âŒ Google Drive íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:", error);
    throw error;
  }
}

/**
 * ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ (í† í° ì‚­ì œ)
 *
 * @param userEmail - ì‚¬ìš©ì ì´ë©”ì¼
 */
export function logoutUser(userEmail: string): void {
  console.log(`ğŸ‘‹ ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ: ${userEmail}`);
  tokenStorage.delete(userEmail);
  console.log("âœ… í† í° ì‚­ì œ ì™„ë£Œ");
}

/**
 * ì‚¬ìš©ì í† í° ì •ë³´ ì¡°íšŒ (ë””ë²„ê¹…ìš©)
 */
export function getUserTokenInfo(userEmail: string) {
  const token = tokenStorage.get(userEmail);

  if (!token) {
    return null;
  }

  return {
    email: userEmail,
    hasAccessToken: !!token.access_token,
    hasRefreshToken: !!token.refresh_token,
    isTokenExpired: isTokenExpired(token.expiry_date),
    expiryDate: new Date(token.expiry_date),
  };
}
